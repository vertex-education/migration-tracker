<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Migration Tracker</title>
  <meta name="description" content="Read-only dashboard that renders data/migration-data.json from the public repo vertex-education/migration-tracker." />
  <style>
    :root{
      --bg:#0a0f16; --panel:#0f1622; --border:#1c2940; --text:#e6eef8; --muted:#9fb0c6;
      --accent:#1b66ff; --accent-2:#22c55e; --danger:#ef4444; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--text)}
    header{position:sticky; top:0; z-index:5; backdrop-filter:saturate(160%) blur(8px);
      background:linear-gradient(180deg, rgba(10,15,22,.9), rgba(10,15,22,.6)); border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; padding:12px 18px}
    h1{font-size:18px; margin:0}
    main{max-width:1100px; margin:0 auto; padding:18px}
    .row{display:flex; flex-wrap:wrap; gap:12px}
    .col{flex:1 1 260px}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:14px; margin:10px 0}
    .muted{color:var(--muted)}
    .pill{display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid var(--border); background:#0e1a2b; font-size:12px; margin-right:6px}
    .btn{appearance:none; border:0; background:var(--accent); color:white; padding:10px 14px; border-radius:10px; cursor:pointer}
    .btn.secondary{background:#1a2333}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    input[type="text"], input[type="search"], select{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#0b121d; color:var(--text)}
    .grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(260px, 1fr)); gap:12px}
    .kv{display:grid; grid-template-columns: 160px 1fr; gap:6px; align-items:start}
    .kv .k{color:var(--muted)}
    .status{font-size:12px; font-weight:600; letter-spacing:.3px; text-transform:uppercase; padding:4px 8px; border-radius:999px; display:inline-block}
    .status.ok{background:rgba(34,197,94,.15); border:1px solid rgba(34,197,94,.35)}
    .status.warn{background:rgba(245,158,11,.12); border:1px solid rgba(245,158,11,.35)}
    .status.err{background:rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.35)}
    .progress{height:8px; background:#0b121d; border:1px solid var(--border); border-radius:999px; overflow:hidden}
    .progress > span{display:block; height:100%; background:var(--accent-2); width:0%}
    details summary{cursor:pointer; color:var(--muted)}
    pre{white-space:pre-wrap; word-break:break-word}
    a{color:#8ab4ff; text-decoration:none}
    a:hover{text-decoration:underline}
    .footer{padding:22px; text-align:center; color:var(--muted)}
    .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  </style>
</head>
<body>
  <header>
    <h1 id="pageTitle">Migration Tracker</h1>
    <div class="toolbar">
      <span class="pill" id="branchPill">main</span>
      <span class="pill" id="pathPill">data/migration-data.json</span>
      <span class="pill" id="commitPill">—</span>
      <button id="refreshBtn" class="btn secondary" title="Reload data">Refresh</button>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="row">
        <div class="col">
          <div class="muted">Last Updated</div>
          <div id="lastUpdated">—</div>
        </div>
        <div class="col">
          <div class="muted">Repository</div>
          <div>
            <a id="repoLink" href="https://github.com/vertex-education/migration-tracker" target="_blank" rel="noopener">vertex-education/migration-tracker</a>
          </div>
        </div>
        <div class="col">
          <div class="muted">Search</div>
          <input id="searchBox" type="search" placeholder="Filter cards (name, title, status, etc.)" />
        </div>
        <div class="col">
          <div class="muted">Auto-refresh</div>
          <select id="autoRefresh">
            <option value="0">Off</option>
            <option value="30">Every 30s</option>
            <option value="60">Every 1m</option>
            <option value="300">Every 5m</option>
          </select>
        </div>
      </div>
    </section>

    <section id="overview" class="card" style="display:none"></section>

    <section id="sections"></section>

    <section id="errors" class="card" style="display:none">
      <div id="errorText" class="muted"></div>
    </section>

    <section class="card">
      <details>
        <summary>View raw JSON</summary>
        <pre id="raw"></pre>
      </details>
    </section>
  </main>

  <div class="footer">© Vertex Education</div>

<script>
(function(){
  const OWNER = 'vertex-education';
  const REPO = 'migration-tracker';
  const BRANCH = 'main';
  const PATH = 'data/migration-data.json';
  const RAW_URL = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${PATH}`;
  const COMMITS_API = `https://api.github.com/repos/${OWNER}/${REPO}/commits?path=${encodeURIComponent(PATH)}&sha=${encodeURIComponent(BRANCH)}&per_page=1`;

  // Elements
  const lastUpdatedEl = document.getElementById('lastUpdated');
  const commitPill = document.getElementById('commitPill');
  const branchPill = document.getElementById('branchPill');
  const pathPill = document.getElementById('pathPill');
  const repoLink = document.getElementById('repoLink');
  const rawEl = document.getElementById('raw');
  const sectionsEl = document.getElementById('sections');
  const overviewEl = document.getElementById('overview');
  const errorBox = document.getElementById('errors');
  const errorText = document.getElementById('errorText');
  const refreshBtn = document.getElementById('refreshBtn');
  const searchBox = document.getElementById('searchBox');
  const pageTitle = document.getElementById('pageTitle');
  const autoRefreshSel = document.getElementById('autoRefresh');

  let dataCache = null; // last loaded JSON
  let refreshTimer = null;

  function escapeHTML(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
  }
  function fmtDate(d){
    try{
      const dt = (d instanceof Date) ? d : new Date(d);
      if(isNaN(+dt)) return String(d);
      return dt.toLocaleString(undefined, {year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'});
    }catch{ return String(d); }
  }
  function percentFrom(val){
    if(val == null) return null;
    let n = Number(val);
    if(!isFinite(n)) return null;
    if(n<=1) n = n*100;
    n = Math.max(0, Math.min(100, n));
    return Math.round(n);
  }

  async function fetchJSON(){
    const url = RAW_URL + `?t=${Date.now()}`;
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error(`Failed to load JSON (${res.status})`);
    return res.json();
  }
  async function fetchCommitMeta(){
    try{
      const res = await fetch(COMMITS_API, {cache:'no-store'});
      if(!res.ok) return null;
      const arr = await res.json();
      if(!Array.isArray(arr) || arr.length === 0) return null;
      const c = arr[0];
      const sha = (c && c.sha) ? c.sha.substring(0,7) : '—';
      const date = c && c.commit && c.commit.author && c.commit.author.date;
      const htmlUrl = c && c.html_url;
      return {sha, date, htmlUrl};
    }catch{ return null; }
  }

  function clear(el){ while(el.firstChild) el.removeChild(el.firstChild); }

  function renderOverview(obj){
    const top = obj && typeof obj === 'object' ? obj : {};
    const info = [];
    const lu = top.lastUpdated || top.updated || top.last_update || top.timestamp;
    const title = top.title || top.name || 'Migration Tracker';

    // Title override
    pageTitle.textContent = escapeHTML(title);

    // Last updated preference: file field, else commit meta filled later
    lastUpdatedEl.textContent = lu ? escapeHTML(fmtDate(lu)) : '—';

    // Compute basic status counts if a conventional array exists
    let statusCounts = {};
    const arrays = Object.entries(top).filter(([k,v]) => Array.isArray(v));
    arrays.forEach(([k, arr]) => {
      arr.forEach(item => {
        if(item && typeof item === 'object' && 'status' in item){
          const s = String(item.status || '').toLowerCase();
          if(!s) return;
          statusCounts[s] = (statusCounts[s]||0)+1;
        }
      });
    });

    clear(overviewEl);
    const wrap = document.createElement('div');
    const kv = document.createElement('div'); kv.className = 'kv';

    // Basic KVs
    const kvPair = (k,v)=>{
      const kEl = document.createElement('div'); kEl.className='k'; kEl.textContent=k;
      const vEl = document.createElement('div'); vEl.innerHTML = escapeHTML(v);
      kv.appendChild(kEl); kv.appendChild(vEl);
    };

    kvPair('Title', title);
    kvPair('Data file', `${BRANCH}/${PATH}`);

    if(Object.keys(statusCounts).length){
      const chips = Object.entries(statusCounts).map(([s,n])=>`<span class="pill">${escapeHTML(s)}: ${n}</span>`).join(' ');
      kvPair('Status counts', chips);
    }

    wrap.appendChild(kv);
    overviewEl.appendChild(wrap);
    overviewEl.style.display='';
  }

  function statusClass(s){
    if(!s) return ''; const t = String(s).toLowerCase();
    if(/^(ok|green|done|complete|success|healthy)$/.test(t)) return 'ok';
    if(/^(warn|warning|yellow|at risk|blocked)$/.test(t)) return 'warn';
    if(/^(err|error|red|failed|issue|critical)$/.test(t)) return 'err';
    return '';
  }

  function guessLabel(obj){
    const keys = ['name','title','id','key','project','task'];
    for(const k of keys){ if(obj[k]) return obj[k]; }
    return '';
  }

  function renderArraySection(name, arr){
    const sec = document.createElement('section');
    sec.className = 'card';

    const h = document.createElement('h2'); h.textContent = name; h.style.marginTop='6px'; h.style.fontSize='16px'; h.style.marginBottom='12px';
    sec.appendChild(h);

    const grid = document.createElement('div'); grid.className='grid';

    arr.forEach(item => {
      const card = document.createElement('div'); card.className='card';
      card.setAttribute('data-search', JSON.stringify(item).toLowerCase());

      if(item && typeof item === 'object'){
        const label = guessLabel(item) || '(item)';
        const status = item.status != null ? String(item.status) : '';
        const sClass = statusClass(status);
        const head = document.createElement('div');
        head.style.display='flex'; head.style.justifyContent='space-between'; head.style.alignItems='center'; head.style.marginBottom='8px';
        const title = document.createElement('div'); title.style.fontWeight='600'; title.textContent = label;
        head.appendChild(title);
        if(status){
          const st = document.createElement('span'); st.className = `status ${sClass}`; st.textContent = status; head.appendChild(st);
        }
        card.appendChild(head);

        // Progress if any
        const pKeys = ['percent','progress','completion','complete','done'];
        let pct=null; for(const k of pKeys){ if(k in item){ pct = percentFrom(item[k]); if(pct!=null) break; }}
        if(pct!=null){
          const bar = document.createElement('div'); bar.className='progress';
          const fill = document.createElement('span'); fill.style.width = pct+"%"; bar.appendChild(fill);
          const labelEl = document.createElement('div'); labelEl.className='muted'; labelEl.style.marginTop='6px'; labelEl.textContent = `Progress: ${pct}%`;
          card.appendChild(bar); card.appendChild(labelEl);
        }

        // Key-values of remaining fields
        const table = document.createElement('div'); table.className='kv'; table.style.marginTop='8px';
        Object.entries(item).forEach(([k,v]) => {
          if(['status','percent','progress','completion','complete','done'].includes(k)) return;
          if(['name','title','id','key','project','task'].includes(k)) return;
          const kEl = document.createElement('div'); kEl.className='k'; kEl.textContent = k;
          const vEl = document.createElement('div');
          if(Array.isArray(v) || (v && typeof v === 'object')){
            vEl.textContent = JSON.stringify(v, null, 2);
          } else {
            vEl.textContent = String(v);
          }
          table.appendChild(kEl); table.appendChild(vEl);
        });
        card.appendChild(table);
      } else {
        const t = document.createElement('div'); t.textContent = String(item);
        card.appendChild(t);
      }

      grid.appendChild(card);
    });

    sec.appendChild(grid);
    sectionsEl.appendChild(sec);
  }

  function renderAll(obj){
    clear(sectionsEl);

    // Overview
    renderOverview(obj);

    // Render arrays at the top level as separate sections
    let renderedAny = false;
    Object.entries(obj).forEach(([k,v]) => {
      if(Array.isArray(v)){
        renderedAny = true;
        renderArraySection(k, v);
      }
    });

    if(!renderedAny){
      // If there are no arrays, show the whole object as a single section of KVs
      const sec = document.createElement('section'); sec.className='card';
      const h = document.createElement('h2'); h.textContent = 'Data'; h.style.marginTop='6px'; h.style.fontSize='16px'; h.style.marginBottom='12px';
      sec.appendChild(h);
      const table = document.createElement('div'); table.className='kv';
      Object.entries(obj).forEach(([k,v]) => {
        const kEl = document.createElement('div'); kEl.className='k'; kEl.textContent = k;
        const vEl = document.createElement('div'); vEl.textContent = (typeof v === 'object') ? JSON.stringify(v, null, 2) : String(v);
        table.appendChild(kEl); table.appendChild(vEl);
      });
      sec.appendChild(table);
      sectionsEl.appendChild(sec);
    }

    // Raw JSON
    rawEl.textContent = JSON.stringify(obj, null, 2);
  }

  function applySearch(){
    const q = (searchBox.value || '').trim().toLowerCase();
    const cards = sectionsEl.querySelectorAll('[data-search]');
    if(!q){ cards.forEach(c => c.style.display=''); return; }
    cards.forEach(c => {
      const t = c.getAttribute('data-search');
      c.style.display = t.includes(q) ? '' : 'none';
    });
  }

  async function load(){
    errorBox.style.display='none';
    try{
      const [obj, meta] = await Promise.all([fetchJSON(), fetchCommitMeta()]);
      dataCache = obj;
      renderAll(obj);

      // Commit meta
      if(meta){
        commitPill.innerHTML = meta.htmlUrl ? `<a href="${meta.htmlUrl}" target="_blank" rel="noopener">${meta.sha}</a>` : meta.sha;
        if(!obj.lastUpdated && meta.date){
          lastUpdatedEl.textContent = fmtDate(meta.date);
        }
      } else {
        commitPill.textContent = '—';
      }
    } catch(err){
      console.error(err);
      errorText.textContent = `${err.message || err}`;
      errorBox.style.display='';
    }
  }

  function scheduleAutoRefresh(){
    if(refreshTimer){ clearInterval(refreshTimer); refreshTimer = null; }
    const secs = Number(autoRefreshSel.value || '0');
    if(secs > 0){
      refreshTimer = setInterval(load, secs*1000);
    }
  }

  // Init
  branchPill.textContent = BRANCH;
  pathPill.textContent = PATH;
  repoLink.href = `https://github.com/${OWNER}/${REPO}`;

  refreshBtn.addEventListener('click', load);
  searchBox.addEventListener('input', applySearch);
  autoRefreshSel.addEventListener('change', scheduleAutoRefresh);

  load();
  scheduleAutoRefresh();
})();
</script>
</body>
</html>
